name: Build and Publish PDF

on:
  push:
    branches:
      - main
      - master
    paths:
      - '_history/**'
      - '_entertainment/**'
      - '_metaphysics/**'
      - 'scripts/**'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘

jobs:
  build-pdf:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æŠŠ PDF æ¨é€å›ä»“åº“

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Python dependencies
        run: pip install pyyaml

      - name: Install Pandoc and LaTeX (with Chinese Fonts)
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended fonts-noto-cjk
          # fonts-noto-cjk æ˜¯å¼€æºçš„ Google Noto CJK å­—ä½“ï¼Œæ”¯æŒç®€ä½“ä¸­æ–‡

      - name: Generate Merged Markdown
        run: python scripts/generate_pdf_source.py

      - name: Convert to PDF
        run: |
          # ä½¿ç”¨ xelatex å¼•æ“ï¼Œå¹¶æŒ‡å®šä¸­æ–‡å­—ä½“
          pandoc full_project.md -o HongQing_Archives.pdf \
            --pdf-engine=xelatex \
            -V CJKmainfont="Noto Sans CJK SC" \
            -V geometry:margin=1in \
            --toc \
            --toc-depth=2
            
      - name: Commit PDF to Repo
        run: |
          # 1. æ£€æŸ¥ PDF æ˜¯å¦çœŸçš„ç”Ÿæˆäº†
          if [ -f "HongQing_Archives.pdf" ]; then
            echo "âœ… PDF æˆåŠŸç”Ÿæˆï¼Œå‡†å¤‡ç§»åŠ¨..."
          else
            echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°ç”Ÿæˆçš„ PDF æ–‡ä»¶ï¼è¯·æ£€æŸ¥ä¸Šä¸€æ­¥ pandoc æ˜¯å¦æŠ¥é”™ã€‚"
            ls -R  # åˆ—å‡ºå½“å‰æ‰€æœ‰æ–‡ä»¶å¸®æˆ‘ä»¬æ‰¾åŸå› 
            exit 1
          fi

          # 2. ç¡®ä¿ç›®å½•å­˜åœ¨
          mkdir -p assets/downloads
          
          # 3. ç§»åŠ¨æ–‡ä»¶ (è¦†ç›–æ—§çš„)
          mv -f HongQing_Archives.pdf assets/downloads/HongQing_Archives.pdf
          
          # 4. é…ç½® Git èº«ä»½ (å¿…é¡»é…ç½®ï¼Œå¦åˆ™æ— æ³•æäº¤)
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 5. æäº¤å¹¶æ¨é€
          git add assets/downloads/HongQing_Archives.pdf
          
          # åªæœ‰å½“æ–‡ä»¶æœ‰å˜åŒ–æ—¶æ‰æäº¤
          if git diff --staged --quiet; then
            echo "âš ï¸ PDF å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            git commit -m "Auto-update PDF export [skip ci]"
            git push
            echo "ğŸš€ PDF å·²æˆåŠŸæ¨é€åˆ°ä»“åº“ï¼"
          fi
